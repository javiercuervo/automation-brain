# GitHub Actions workflow for processing Pabbly submissions
#
# Triggered by repository_dispatch from pabbly-mapper Cloud Run service
# Creates a JSON file with the mapped payload and opens a PR
#
# Event type: pabbly_submission
# client_payload: { submissionId, mappedPayload, timestamp }

name: Process Pabbly Submission

on:
  repository_dispatch:
    types: [pabbly_submission]

permissions:
  contents: write
  pull-requests: write

jobs:
  process-submission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract submission data
        id: extract
        run: |
          SUBMISSION_ID="${{ github.event.client_payload.submissionId }}"
          TIMESTAMP="${{ github.event.client_payload.timestamp }}"

          # Sanitize submission ID for branch/file names
          SAFE_ID=$(echo "$SUBMISSION_ID" | sed 's/[^a-zA-Z0-9_-]/-/g')

          echo "submission_id=$SUBMISSION_ID" >> $GITHUB_OUTPUT
          echo "safe_id=$SAFE_ID" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "branch_name=pabbly/sub-$SAFE_ID" >> $GITHUB_OUTPUT

          echo "Processing submission: $SUBMISSION_ID"
          echo "Timestamp: $TIMESTAMP"

      - name: Create branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="${{ steps.extract.outputs.branch_name }}"

          # Check if branch exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, checking out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Creating new branch: $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
          fi

      - name: Create submission file
        run: |
          # Create data directory if it doesn't exist
          mkdir -p data/submissions

          SUBMISSION_ID="${{ steps.extract.outputs.submission_id }}"
          SAFE_ID="${{ steps.extract.outputs.safe_id }}"
          TIMESTAMP="${{ steps.extract.outputs.timestamp }}"

          # Write the mapped payload to a JSON file
          cat << 'PAYLOAD_EOF' > "data/submissions/${SAFE_ID}.json"
          ${{ toJson(github.event.client_payload.mappedPayload) }}
          PAYLOAD_EOF

          # Pretty print the JSON
          cat "data/submissions/${SAFE_ID}.json" | jq '.' > "data/submissions/${SAFE_ID}.tmp" 2>/dev/null || true
          if [ -f "data/submissions/${SAFE_ID}.tmp" ] && [ -s "data/submissions/${SAFE_ID}.tmp" ]; then
            mv "data/submissions/${SAFE_ID}.tmp" "data/submissions/${SAFE_ID}.json"
          fi

          echo "Created file: data/submissions/${SAFE_ID}.json"
          cat "data/submissions/${SAFE_ID}.json"

      - name: Commit and push
        run: |
          SUBMISSION_ID="${{ steps.extract.outputs.submission_id }}"
          SAFE_ID="${{ steps.extract.outputs.safe_id }}"
          BRANCH_NAME="${{ steps.extract.outputs.branch_name }}"

          git add "data/submissions/${SAFE_ID}.json"

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit (file may already exist with same content)"
            exit 0
          fi

          git commit -m "feat: add submission ${SUBMISSION_ID} from Pabbly

Automated submission received via pabbly-mapper service.
Timestamp: ${{ steps.extract.outputs.timestamp }}"

          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SUBMISSION_ID="${{ steps.extract.outputs.submission_id }}"
          SAFE_ID="${{ steps.extract.outputs.safe_id }}"
          BRANCH_NAME="${{ steps.extract.outputs.branch_name }}"
          TIMESTAMP="${{ steps.extract.outputs.timestamp }}"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for branch $BRANCH_NAME"
            echo "PR URL: https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
            exit 0
          fi

          # Create the PR
          gh pr create \
            --title "feat: Pabbly submission ${SUBMISSION_ID}" \
            --body "## Submission from Pabbly Connect

**Submission ID:** \`${SUBMISSION_ID}\`
**Received at:** ${TIMESTAMP}

### Mapped Data
See \`data/submissions/${SAFE_ID}.json\` for the full payload.

---
*This PR was auto-generated by the pabbly-mapper service via repository_dispatch.*" \
            --base main \
            --head "$BRANCH_NAME"

          echo "Pull request created successfully"
